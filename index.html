<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  height:100vh;
  font-family:Inter,sans-serif;
  background:#0b0f14;
  color:#e6edf3;
  display:flex;
}
#app{display:flex;width:100%}

#rooms{
  width:220px;
  background:#0f141b;
  border-right:1px solid #1f2630;
  padding:10px;
}

#chat{
  flex:1;
  display:flex;
  flex-direction:column;
}

#messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
}

.msg{margin-bottom:10px}
.name{font-weight:600}
.time{font-size:11px;color:#8b949e;margin-left:6px}

#typing{
  font-size:12px;
  color:#8b949e;
  padding:0 15px 5px;
  min-height:16px;
}

#input{
  display:flex;
  gap:5px;
  padding:10px;
  border-top:1px solid #1f2630;
}

#msg{
  flex:1;
  background:#0f141b;
  border:1px solid #1f2630;
  color:#e6edf3;
  padding:8px;
  border-radius:6px;
}

button{
  background:#1f6feb;
  border:none;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

#emojiBtn{
  background:#161b22;
}

#emojiPicker{
  position:absolute;
  bottom:60px;
  right:20px;
  background:#0f141b;
  border:1px solid #1f2630;
  padding:8px;
  border-radius:8px;
  display:none;
  max-width:220px;
}

#emojiPicker span{
  cursor:pointer;
  font-size:20px;
  padding:4px;
}
</style>
</head>

<body>
<div id="app">
  <div id="rooms">
    <b>Huone</b><br><br>
    <input id="room" placeholder="huone"><br><br>
    <input id="pass" placeholder="salasana"><br><br>
    <input id="nick" placeholder="nimi"><br><br>
    <button onclick="join()">Liity</button>
  </div>

  <div id="chat">
    <div id="messages"></div>
    <div id="typing"></div>

    <div id="input">
      <button id="emojiBtn">ğŸ˜€</button>
      <input id="msg" placeholder="Viesti...">
      <button onclick="send()">Send</button>
    </div>
  </div>
</div>

<div id="emojiPicker">
  ğŸ˜€ ğŸ˜ ğŸ˜‚ ğŸ¤£ ğŸ˜ ğŸ˜ ğŸ˜˜ ğŸ˜­ ğŸ˜¡ ğŸ‘ ğŸ‘ ğŸ™ ğŸ’€ ğŸ”¥ ğŸ‰ â¤ï¸  
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,collection,doc,setDoc,getDoc,
  addDoc,onSnapshot,query,orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"XXX",
  authDomain:"XXX",
  projectId:"XXX"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let room="",nick="";
const messages=document.getElementById("messages");
const typingIndicator=document.getElementById("typing");
const msgInput=document.getElementById("msg");

/* ğŸ”” Notifications */
if(Notification.permission!=="granted"){
  Notification.requestPermission();
}

async function join(){
  room=room.value.trim();
  nick=nick.value.trim();
  const pass=pass.value;

  if(!room||!nick) return;

  const roomRef=doc(db,"rooms",room);
  const snap=await getDoc(roomRef);

  if(!snap.exists()){
    await setDoc(roomRef,{pass});
  }else if(snap.data().pass!==pass){
    alert("VÃ¤Ã¤rÃ¤ salasana");
    return;
  }

  loadMessages();
  listenTyping();
}

function loadMessages(){
  messages.innerHTML="";
  const q=query(collection(db,"rooms",room,"messages"),orderBy("t"));
  onSnapshot(q,snap=>{
    snap.docChanges().forEach(c=>{
      if(c.type==="added"){
        const d=c.doc.data();
        const el=document.createElement("div");
        el.className="msg";
        el.innerHTML=`<span class="name">${d.n}</span>
          <span class="time">${new Date(d.t).toLocaleTimeString()}</span><br>
          ${d.m}`;
        messages.appendChild(el);
        messages.scrollTop=messages.scrollHeight;

        if(document.hidden){
          new Notification("New message.");
        }
      }
    });
  });
}

async function send(){
  if(!msgInput.value.trim()) return;
  await addDoc(collection(db,"rooms",room,"messages"),{
    n:nick,
    m:msgInput.value,
    t:Date.now()
  });
  msgInput.value="";
}

/* âœï¸ TYPING â€“ EI JÃ„Ã„ PÃ„Ã„LLE */
msgInput.addEventListener("input",()=>{
  if(!room||!nick) return;
  setDoc(doc(db,"rooms",room,"typing",nick),{
    t:Date.now()
  });
});

function listenTyping(){
  onSnapshot(collection(db,"rooms",room,"typing"),snap=>{
    const now=Date.now();
    const users=[];
    snap.forEach(d=>{
      if(d.id===nick) return;
      if(now-d.data().t<2000){
        users.push(d.id);
      }
    });
    typingIndicator.textContent=
      users.length?users.join(", ")+" typing...":"";
  });
}

/* ğŸ˜€ EMOJIT */
const picker=document.getElementById("emojiPicker");
document.getElementById("emojiBtn").onclick=()=>{
  picker.style.display=picker.style.display==="block"?"none":"block";
};
picker.onclick=e=>{
  if(e.target.tagName==="SPAN"){
    msgInput.value+=e.target.textContent;
  }
};
</script>
</body>
</html>
