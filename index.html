<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mini Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: #18191a;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
  }
  h1 { margin-top: 20px; }
  #login, #chatUI { width: 90%; max-width: 500px; margin-top: 20px; }
  input, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: none; font-size: 1rem; }
  input { background: #242526; color: #eee; }
  button { background: #4b9ce2; color: #fff; font-weight: 600; cursor: pointer; transition: 0.2s; }
  button:hover { background: #3a8ad1; }
  #chat { height: 350px; overflow-y: auto; background: #242526; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; flex-direction: column; }
  .message { margin-bottom: 8px; word-wrap: break-word; }
  .message b { color: #4b9ce2; }
  #msg { margin-top: 10px; }
  .hidden { display: none; }
  @media (max-width: 600px) {
    #chat { height: 300px; }
  }
</style>
</head>
<body>

<h1 id="title">ðŸ”¥ Mini Chat</h1>

<div id="login">
  <input id="nick" placeholder="Choose your nickname">
  <input id="room" placeholder="Room name">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="join()">Join / Create Room</button>
</div>

<div id="chatUI" class="hidden">
  <div id="chat"></div>
  <input id="msg" placeholder="Type a message (Enter = send)">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  authDomain: "chat-fc8ef.firebaseapp.com",
  projectId: "chat-fc8ef",
  storageBucket: "chat-fc8ef.appspot.com",
  messagingSenderId: "446356718094",
  appId: "1:446356718094:web:f56514352845d6bbb7b25f"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRoom = "";
let unsub = null;

const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const nickInput = document.getElementById("nick");

// Load nickname from localStorage
let nick = localStorage.getItem("nick") || "";
if (nick) nickInput.value = nick;

// ENTER = send
msgInput.addEventListener("keydown", e => { if(e.key==="Enter") send(); });
nickInput.addEventListener("keydown", e => { if(e.key==="Enter") join(); });

window.join = async () => {
  let room = document.getElementById("room").value.trim();
  let pass = document.getElementById("pass").value;
  nick = document.getElementById("nick").value.trim() || "Anon";

  if (!room || !pass) { alert("Please enter room name and password"); return; }
  if (!nick) { alert("Please enter a nickname"); return; }

  localStorage.setItem("nick", nick);

  const roomRef = doc(db, "rooms", room);
  const snap = await getDoc(roomRef);
  const now = Date.now();
  const day = 24 * 60 * 60 * 1000;

  if (!snap.exists()) {
    // Create room
    await setDoc(roomRef, {
      password: pass,
      roomExpiresAt: new Date(now + day)
    });
  } else {
    if (snap.data().password !== pass) { alert("Wrong password"); return; }
    await setDoc(roomRef, {
      roomExpiresAt: new Date(now + day)
    }, { merge: true });
  }

  currentRoom = room;
  document.getElementById("login").classList.add("hidden");
  document.getElementById("chatUI").classList.remove("hidden");
  document.getElementById("title").innerText = `ðŸ”¥ Room: ${room}`;

  const q = query(collection(db, "rooms", room, "messages"), orderBy("time"));
  unsub = onSnapshot(q, snap => {
    chat.innerHTML = "";
    snap.forEach(d => {
      const m = d.data();
      chat.innerHTML += `<div class="message"><b>${m.name}:</b> ${m.text}</div>`;
    });
    chat.scrollTop = chat.scrollHeight;
  });
};

window.send = async () => {
  const text = msgInput.value.trim();
  if (!text) return;

  // Commands
  if (text === "/clear") {
    if (!confirm("Clear all messages in this room?")) return;
    const msgs = await getDocs(collection(db, "rooms", currentRoom, "messages"));
    msgs.forEach(d => deleteDoc(d.ref));
    msgInput.value = "";
    return;
  }
  if (text === "/delete") {
    if (!confirm("DELETE ENTIRE ROOM?")) return;
    const msgs = await getDocs(collection(db, "rooms", currentRoom, "messages"));
    msgs.forEach(d => deleteDoc(d.ref));
    await deleteDoc(doc(db, "rooms", currentRoom));
    location.reload();
    return;
  }

  // Normal message
  await addDoc(collection(db, "rooms", currentRoom, "messages"), {
    name: nick,
    text,
    time: serverTimestamp(),
    expiresAt: new Date(Date.now() + 24*60*60*1000)
  });

  msgInput.value = "";
};
</script>

</body>
</html>
