<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}
body{
  margin:0;height:100vh;font-family:Inter,sans-serif;
  background:#1e1f22;color:#dbdee1;display:flex
}
.hidden{display:none}
#home,#main{flex:1;padding:20px}
#chat{height:calc(100vh - 160px);overflow-y:auto;padding:10px}
.message{margin-bottom:12px}
.message b{color:#fff}
.time{font-size:11px;color:#949ba4;margin-left:6px}
#typing{height:18px;font-size:12px;color:#949ba4}
#msg{width:100%;padding:12px;border-radius:8px;border:none;background:#2b2d31;color:#fff}
#users{
  width:200px;background:#2b2d31;padding:12px;border-left:1px solid #1f2023
}
</style>
</head>

<body>

<div id="home">
  <h2>Join chat</h2>
  <input id="nick" placeholder="Username">
  <button id="join">Join room</button>
</div>

<div id="main" class="hidden">
  <button id="back">‚Üê Leave</button>
  <h3 id="roomName"></h3>
  <div id="chat"></div>
  <div id="typing"></div>
  <input id="msg" placeholder="Message or /command">
</div>

<div id="users">
  <b>Online</b>
  <div id="userList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, addDoc,
  getDocs, query, orderBy, onSnapshot, serverTimestamp,
  deleteDoc, writeBatch
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
});
const db = getFirestore(app);

/* STATE */
let room="", nick="", heartbeat;
const chat = document.getElementById("chat");
const typingEl = document.getElementById("typing");
const msg = document.getElementById("msg");

/* PERSIST NICK */
nick.value = localStorage.getItem("nick") || "";

/* JOIN */
join.onclick = async ()=>{
  room = prompt("Room name");
  if(!room) return;

  nick = document.getElementById("nick").value.trim();
  if(!nick) return alert("Nick required");
  localStorage.setItem("nick",nick);

  const userRef = doc(db,"rooms",room,"users",nick);
  const snap = await getDoc(userRef);

  if(snap.exists()){
    const last = snap.data().lastActive?.toMillis() || 0;
    if(Date.now() - last < 180000){
      return alert("Nick already online");
    }
  }

  await setDoc(userRef,{ lastActive: serverTimestamp() });

  heartbeat = setInterval(()=>{
    setDoc(userRef,{ lastActive: serverTimestamp() },{merge:true});
  },30000);

  window.addEventListener("beforeunload",()=>deleteDoc(userRef));

  home.classList.add("hidden");
  main.classList.remove("hidden");
  roomName.textContent="# "+room;

  /* ONLINE LIST (3 min timeout) */
  onSnapshot(collection(db,"rooms",room,"users"),snap=>{
    userList.innerHTML="";
    snap.forEach(d=>{
      const last=d.data().lastActive?.toMillis()||0;
      if(Date.now()-last < 180000){
        userList.innerHTML+=`<div>üü¢ ${d.id}</div>`;
      }
    });
  });

  /* TYPING */
  onSnapshot(collection(db,"rooms",room,"typing"),snap=>{
    const arr=[];
    snap.forEach(d=>{
      if(d.id!==nick && d.data().typing) arr.push(d.id);
    });
    typingEl.textContent = arr.length ? arr.join(", ")+" is typing..." : "";
  });

  /* MESSAGES */
  const q=query(collection(db,"rooms",room,"messages"),orderBy("time"));
  onSnapshot(q,s=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const t=m.time?.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      chat.innerHTML+=`
        <div class="message">
          <b>${m.name}</b>
          <span class="time">${t||""}</span>
          <div>${m.text}</div>
        </div>`;

      if(m.name!==nick && Notification.permission==="granted"){
        const n=new Notification(`${m.name}`,{body:m.text});
        setTimeout(()=>n.close(),500);
      }
    });
    chat.scrollTop=chat.scrollHeight;
  });
};

/* SEND + COMMANDS (KAIKILLE OIKEUDET) */
msg.addEventListener("keydown",async e=>{
  if(e.key!=="Enter" || !msg.value) return;
  const text=msg.value.trim();
  msg.value="";

  // /clear
  if(text==="/clear"){
    const snap=await getDocs(collection(db,"rooms",room,"messages"));
    const batch=writeBatch(db);
    snap.forEach(d=>batch.delete(d.ref));
    await batch.commit();
    return;
  }

  // /deleteroom
  if(text==="/deleteroom"){
    const batch=writeBatch(db);
    for(const c of ["messages","users","typing"]){
      const s=await getDocs(collection(db,"rooms",room,c));
      s.forEach(d=>batch.delete(d.ref));
    }
    batch.delete(doc(db,"rooms",room));
    await batch.commit();
    location.reload();
    return;
  }

  // normal message
  await addDoc(collection(db,"rooms",room,"messages"),{
    name:nick,text,time:serverTimestamp()
  });
});

/* TYPING FLAG */
msg.addEventListener("input",()=>{
  setDoc(doc(db,"rooms",room,"typing",nick),{typing:true});
  setTimeout(()=>setDoc(doc(db,"rooms",room,"typing",nick),{typing:false}),1200);
});

/* LEAVE */
back.onclick=()=>{
  clearInterval(heartbeat);
  deleteDoc(doc(db,"rooms",room,"users",nick));
  location.reload();
};

/* NOTIFICATIONS */
if(Notification.permission!=="granted"){
  Notification.requestPermission();
}
</script>
</body>
</html>
