<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}
body{margin:0;height:100vh;font-family:Inter;background:#1e1f22;color:#dbdee1}
#app{display:flex;height:100%}
#sidebar{width:240px;background:#2b2d31;padding:12px}
.room{padding:10px;border-radius:6px;cursor:pointer}
.room:hover{background:#404249}
#main{flex:1;display:flex;flex-direction:column}
#header{height:48px;background:#313338;display:flex;align-items:center;justify-content:space-between;padding:0 12px}
#chat{flex:1;padding:16px;overflow-y:auto}
.message{margin-bottom:14px}
.message b{color:#fff}
.time{font-size:11px;color:#949ba4;margin-left:6px}
#typing{height:18px;font-size:12px;color:#949ba4;padding-left:16px}
#inputBar{padding:12px;background:#383a40}
#inputBar input{width:100%;padding:12px;border-radius:8px;border:none;background:#1e1f22;color:#dbdee1}
#users{width:220px;background:#2b2d31;padding:12px}
#home{position:absolute;inset:0;background:#1e1f22;display:flex}
#homeLeft{width:240px;background:#2b2d31;padding:12px}
#homeCenter{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center}
#homeCenter input,#homeCenter button{width:300px;padding:14px;margin-bottom:12px;border-radius:8px;border:none}
#homeCenter input{background:#2b2d31;color:#fff}
#homeCenter button{background:#5865f2;color:#fff;font-weight:600;cursor:pointer}
</style>
</head>
<body>

<div id="app">

<div id="home">
  <div id="homeLeft"><div id="roomList"></div></div>
  <div id="homeCenter">
    <input id="nick" placeholder="Username">
    <button id="createRoom">Create / Join</button>
  </div>
</div>

<div id="sidebar"></div>

<div id="main">
  <div id="header">
    <span id="roomName">Select room</span>
    <span id="toggleUsers">ðŸ‘¥</span>
  </div>
  <div id="chat"></div>
  <div id="typing"></div>
  <div id="inputBar">
    <input id="msg" placeholder="Message...">
  </div>
</div>

<div id="users">
  <b>Online</b>
  <div id="userList"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
});
const db = getFirestore(app);

let room="", nick="";
const chat = document.getElementById("chat");
const typingEl = document.getElementById("typing");
const msg = document.getElementById("msg");

nick.value = localStorage.getItem("nick") || "";

async function loadRooms(){
  roomList.innerHTML="";
  const s = await getDocs(collection(db,"rooms"));
  s.forEach(r=>{
    const d=document.createElement("div");
    d.className="room";
    d.textContent="# "+r.id;
    d.onclick=()=>join(r.id);
    roomList.appendChild(d);
  });
}
loadRooms();

async function join(r){
  nick = document.getElementById("nick").value || "Anon";
  localStorage.setItem("nick", nick);

  room = r;
  roomName.textContent="# "+r;
  home.style.display="none";

  const userRef = doc(db,"rooms",room,"users",nick);
  await setDoc(userRef,{ lastActive: Date.now() });

  setInterval(()=>{
    setDoc(userRef,{ lastActive: Date.now() });
  },30000);

  onSnapshot(collection(db,"rooms",room,"users"), snap=>{
    userList.innerHTML="";
    const now = Date.now();
    snap.forEach(u=>{
      if(now - u.data().lastActive < 180000){
        const d=document.createElement("div");
        d.textContent="ðŸŸ¢ "+u.id;
        userList.appendChild(d);
      }
    });
  });

  onSnapshot(collection(db,"rooms",room,"typing"), snap=>{
    const t=[];
    snap.forEach(d=>{
      if(d.id!==nick && d.data().typing) t.push(d.id);
    });
    typingEl.textContent = t.length ? t.join(", ")+" is typing..." : "";
  });

  onSnapshot(query(collection(db,"rooms",room,"messages"),orderBy("time")), snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const t=m.time?.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      chat.innerHTML+=`<div class="message"><b>${m.name}</b><span class="time">${t||""}</span><div>${m.text}</div></div>`;
      if(m.name!==nick && Notification.permission==="granted"){
        const n=new Notification(`${m.name}`,{body:m.text});
        setTimeout(()=>n.close(),500);
      }
    });
    chat.scrollTop=chat.scrollHeight;
  });
}

msg.addEventListener("keydown", async e=>{
  if(e.key==="Enter" && msg.value){
    const text=msg.value.trim();

    if(text==="/clear"){
      const s=await getDocs(collection(db,"rooms",room,"messages"));
      s.forEach(d=>deleteDoc(d.ref));
      msg.value=""; return;
    }

    if(text==="/deleteroom"){
      const cols=["messages","users","typing"];
      for(const c of cols){
        const s=await getDocs(collection(db,"rooms",room,c));
        s.forEach(d=>deleteDoc(d.ref));
      }
      await deleteDoc(doc(db,"rooms",room));
      location.reload(); return;
    }

    await addDoc(collection(db,"rooms",room,"messages"),{
      name:nick,text,time:serverTimestamp()
    });
    msg.value="";
    await setDoc(doc(db,"rooms",room,"typing",nick),{typing:false});
  } else {
    await setDoc(doc(db,"rooms",room,"typing",nick),{typing:true});
    setTimeout(()=>setDoc(doc(db,"rooms",room,"typing",nick),{typing:false}),1200);
  }
});

createRoom.onclick=()=>{
  const r=prompt("Room name");
  if(r) join(r);
};

if(Notification.permission!=="granted") Notification.requestPermission();
</script>
</body>
</html>
