<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MiniChat ‚Äî Drawer tap fix</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14;
    --panel:#161b22;
    --muted:#8b949e;
    --accent:#58a6ff;
    --card:#21262d;
    --text:#e6edf3;
    --lobby-width:260px;
    --drawer-duration: 200ms;
    --drawer-ease: cubic-bezier(.16,.84,.24,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  #app{width:100%;height:100%;position:relative;overflow:hidden}

/* LOGIN */
  #login{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px;background:var(--bg);z-index:30;padding:20px;}
  #login input{padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text);width:100%;max-width:320px}
  #login button{padding:12px 18px;border:none;border-radius:10px;background:var(--accent);color:#000;font-weight:700;cursor:pointer;max-width:320px;width:100%}
  #login .small{background:transparent;border:1px solid #333;padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}

/* APP LAYOUT */
  #home,#main{position:absolute;inset:0;display:none}
  #home{display:flex;flex-direction:row}
  #logoutBtn{position:absolute;top:12px;right:12px;padding:8px 12px;background:#f85149;color:#fff;border:none;border-radius:10px;cursor:pointer;z-index:25;font-weight:700}

/* Lobby (left) */
  #homeLeft{width:var(--lobby-width);min-width:120px;background:var(--panel);padding:12px;border-right:1px solid #0d1117;height:100%;overflow:auto;transition:width 200ms ease,transform 220ms cubic-bezier(.2,.9,.3,1);position:relative;}
  #lobbyHeader{display:flex;align-items:center;gap:8px;margin-bottom:10px}
  #lobbyTitle{flex:1;font-weight:700}
  .room{padding:10px 12px;border-radius:10px;background:var(--card);margin-bottom:8px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;user-select:none;-webkit-user-select:none}
  .room:hover{background:var(--accent);color:#000}

/* controls */
  .iconbtn{background:transparent;border:0;color:var(--text);padding:6px;border-radius:8px;cursor:pointer}
  #lobbySizeBtn{font-weight:700;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03)}

/* MAIN chat */
  #main{display:flex;flex-direction:column}
  #header{height:56px;background:var(--panel);display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #0d1117}
  #roomName{font-weight:700}
  #chatWrapper{display:flex;flex:1;overflow:hidden;min-height:0}
  #chatSidebar{width:var(--lobby-width);background:var(--panel);border-right:1px solid #0d1117;padding:8px;overflow:auto;transition:width 200ms ease;box-sizing:border-box;}
  #chatWrapperMain{flex:1;display:flex;flex-direction:column;min-height:0}
  #chat{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,transparent, rgba(255,255,255,0.01));transition:padding-bottom 120ms ease}
  .message{display:flex;gap:10px;align-items:flex-start}
  .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#000}
  .msg{background:var(--panel);padding:10px 14px;border-radius:12px;position:relative;max-width:90%}
  .time{font-size:11px;color:var(--muted);margin-left:6px}
  .reply-btn{position:absolute;right:8px;top:8px;font-size:12px;color:var(--muted);cursor:pointer;opacity:0}
  .msg:hover .reply-btn{opacity:1}
  .reply-preview{background:rgba(255,255,255,0.02);border-left:3px solid var(--accent);padding:6px;font-size:13px;margin-bottom:8px;border-radius:6px}

/* input area */
  #replyBox{display:none;background:var(--card);padding:8px 14px;font-size:13px;color:var(--text)}
  #inputBar{padding:12px;background:var(--panel);border-top:1px solid #0d1117;display:flex;gap:8px;align-items:center}
  #msg{flex:1;padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text)}
  #emojiPicker{display:none;flex-wrap:wrap;gap:6px;padding:8px;background:var(--card);border-radius:8px;position:absolute;bottom:72px;left:12px;max-width:320px;max-height:200px;overflow:auto}
  #emojiBtn{border:none;background:transparent;color:var(--text);font-size:20px;cursor:pointer}

/* mobile specifics */
  .mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:40;display:none;transition:background var(--drawer-duration) var(--drawer-ease)}
  .mobile-overlay.show{display:block;background:rgba(0,0,0,0.45)}
  .mobile-lobby-drawer{position:fixed;left:0;top:0;height:100%;width:80%;max-width:340px;background:var(--panel);z-index:50;padding:12px;transform:translateX(-110%);transition:transform var(--drawer-duration) var(--drawer-ease),opacity calc(var(--drawer-duration) * 0.9) var(--drawer-ease);opacity:0;will-change:transform}
  .mobile-lobby-drawer.show{transform:translateX(0);opacity:1}
  #openLobbyBtn{position:fixed;left:12px;bottom:12px;background:var(--accent);border:none;padding:12px;border-radius:999px;z-index:60;font-weight:800;color:#000;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.5)}

/* responsive */
  @media (max-width:900px){:root{--lobby-width:220px}}
  @media (max-width:768px){
    #home{flex-direction:column}
    #homeLeft{display:none}
    #chatSidebar{display:none}
    #header{padding:10px}
  }
</style>
</head>
<body>
<div id="app">

  <!-- LOGIN -->
  <div id="login">
    <input id="loginUser" placeholder="K√§ytt√§j√§nimi" autocomplete="username">
    <input id="loginPass" type="password" placeholder="Salasana" autocomplete="current-password">
    <button id="loginBtn">Kirjaudu / Rekister√∂idy</button>
    <button id="demoBtn" class="small">Continue as Guest</button>
  </div>

  <!-- HOME -->
  <div id="home">
    <button id="logoutBtn">Logout</button>

    <!-- Desktop lobby -->
    <aside id="homeLeft" aria-label="Lobby">
      <div id="lobbyHeader">
        <div id="lobbyTitle">Huoneet</div>
        <div id="lobbyControls">
          <button id="lobbyToggle" class="iconbtn">‚óÄ</button>
          <button id="lobbySizeBtn" class="iconbtn">A</button>
        </div>
      </div>
      <div id="roomList"></div>
    </aside>

    <!-- Center -->
    <main id="homeCenter">
      <div id="nickRow" style="display:flex;gap:12px;width:100%;max-width:420px;align-items:center;margin-bottom:20px">
        <input id="nick" placeholder="Nimimerkki (tallennetaan)" style="flex:1;padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text)">
        <div id="nickColorWrapper" style="width:42px;height:42px;position:relative">
          <div id="nickColorCircle" title="V√§ri" style="width:100%;height:100%;border-radius:50%;border:2px solid #fff;cursor:pointer"></div>
          <input type="color" id="nickColor" value="#58a6ff" style="position:absolute;opacity:0;left:0;top:0;width:100%;height:100%;">
        </div>
      </div>
      <button id="createRoom" style="padding:14px 28px;border-radius:12px;background:var(--accent);color:#000;border:none;font-weight:700;cursor:pointer">Luo / Liity huoneeseen</button>
    </main>
  </div>

  <!-- MAIN CHAT -->
  <div id="main" aria-hidden="true">
    <div id="header">
      <div style="display:flex;align-items:center;gap:8px">
        <button id="back" class="iconbtn">‚Üê</button>
        <div id="roomName">#room</div>
      </div>
      <div style="flex:1"></div>
      <div id="typingIndicator" style="color:var(--muted);font-size:13px"></div>
    </div>

    <div id="chatWrapper">
      <aside id="chatSidebar" aria-label="Chat sidebar">
        <div id="chatRoomsHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Huoneet</div>
          <button id="sidebarToggle" class="iconbtn">‚óÄ</button>
        </div>
        <div id="roomListSidebar"></div>
      </aside>

      <div id="chatWrapperMain" style="flex:1;display:flex;flex-direction:column;min-height:0">
        <div id="chat"></div>
        <div id="replyBox"></div>
        <div id="inputBar" style="padding:12px;background:var(--panel);border-top:1px solid #0d1117;display:flex;gap:8px;align-items:center">
          <button id="emojiBtn">üòä</button>
          <input id="msg" placeholder="Viesti... (/clear /delete)" autocomplete="off" style="flex:1;padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text)">
          <div id="emojiPicker"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile overlay and drawer -->
  <div id="mobileOverlay" class="mobile-overlay" aria-hidden="true"></div>
  <div id="mobileDrawer" class="mobile-lobby-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">Huoneet</div>
      <button id="closeDrawer" class="iconbtn">‚úï</button>
    </div>
    <div id="roomListMobile"></div>
  </div>

  <!-- Blue three-line button (mobile) -->
  <button id="openLobbyBtn" title="Avaa lobby">‚ò∞</button>

</div>

<script type="module">
// === Firebase imports ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase init */
const firebaseConfig = { apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc", projectId:"chat-fc8ef" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM refs */
const login = document.getElementById('login');
const home = document.getElementById('home');
const main = document.getElementById('main');
const loginBtn = document.getElementById('loginBtn');
const demoBtn = document.getElementById('demoBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const logoutBtn = document.getElementById('logoutBtn');

const roomList = document.getElementById('roomList');
const roomListSidebar = document.getElementById('roomListSidebar');
const roomListMobile = document.getElementById('roomListMobile');

const createRoomBtn = document.getElementById('createRoom');
const nickInput = document.getElementById('nick');
const nickColorInput = document.getElementById('nickColor');
const nickColorCircle = document.getElementById('nickColorCircle');

const lobby = document.getElementById('homeLeft');
const lobbyToggle = document.getElementById('lobbyToggle');
const lobbySizeBtn = document.getElementById('lobbySizeBtn');

const chatSidebar = document.getElementById('chatSidebar');
const sidebarToggle = document.getElementById('sidebarToggle');

const openLobbyBtn = document.getElementById('openLobbyBtn');
const mobileOverlay = document.getElementById('mobileOverlay');
const mobileDrawer = document.getElementById('mobileDrawer');
const closeDrawer = document.getElementById('closeDrawer');

const chat = document.getElementById('chat');
const msg = document.getElementById('msg');
const replyBox = document.getElementById('replyBox');
const roomName = document.getElementById('roomName');
const emojiPicker = document.getElementById('emojiPicker');
const emojiBtn = document.getElementById('emojiBtn');
const typingIndicator = document.getElementById('typingIndicator');
const back = document.getElementById('back');

let users = JSON.parse(localStorage.getItem('users')||'{}');
let nick = '';
let nickColor = localStorage.getItem('nickColor')||'#58a6ff';
let room = '';
let replyTo = null;
let lastMessageTime = 0;
let typingTimeout = null;
let messagesUnsub = null;
let typingUnsub = null;

/* Device detection */
const isTouch = matchMedia('(pointer:coarse)').matches;
const isMobile = /Mobi|Android|iPhone|iPad|Windows Phone/.test(navigator.userAgent) || isTouch;

/* init */
nickColorInput.value = nickColor;
nickColorCircle.style.background = nickColor;
nickInput.value = localStorage.getItem('nick') || '';
if("Notification" in window && Notification.permission !== 'granted') Notification.requestPermission().catch(()=>{});

/* Keep desktop lobby visible & non-collapsible */
function enforceDesktopLobby(){
  if(!isMobile){
    lobby.style.display = 'block';
    chatSidebar.style.display = 'block';
    if(lobbyToggle) lobbyToggle.style.display = 'none';
    if(sidebarToggle) sidebarToggle.style.display = 'none';
  } else {
    lobby.style.display = 'none';
    chatSidebar.style.display = 'none';
  }
}
enforceDesktopLobby();

/* Session view helpers */
function showHome(){ login.style.display='none'; home.style.display='flex'; main.style.display='none'; updateOpenLobbyBtnVisibility(); }
function showLogin(){ login.style.display='flex'; home.style.display='none'; main.style.display='none'; localStorage.removeItem('session'); updateOpenLobbyBtnVisibility(); }
function showMain(){ login.style.display='none'; home.style.display='none'; main.style.display='flex'; updateOpenLobbyBtnVisibility(); }

if(localStorage.getItem('session')) showHome(); else showLogin();

/* Login handlers */
loginBtn.onclick = ()=>{
  const u = loginUser.value.trim(); const p = loginPass.value;
  if(!u||!p) return alert('T√§yt√§ molemmat kent√§t');
  if(users[u] && users[u] !== p) return alert('V√§√§r√§ salasana');
  users[u] = p; localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('session',u); nickInput.value = u; localStorage.setItem('nick', u); showHome();
};
demoBtn.onclick = ()=>{ const guest = 'Guest'+Math.floor(Math.random()*10000); localStorage.setItem('session',guest); nickInput.value=guest; localStorage.setItem('nick',guest); showHome(); };
logoutBtn.onclick = ()=> showLogin();

/* nick color */
nickColorCircle.addEventListener('click', ()=> nickColorInput.click());
nickColorInput.addEventListener('input', ()=> { nickColorCircle.style.background = nickColorInput.value; localStorage.setItem('nickColor', nickColorInput.value); });

/* Load rooms and render entries ‚Äî attach click & touch handlers that guarantee join works on mobile */
async function loadRooms(){
  roomList.innerHTML=''; roomListSidebar.innerHTML=''; roomListMobile.innerHTML='';
  try{
    const s = await getDocs(collection(db,'rooms'));
    s.forEach(r => renderRoomEntry(r.id));
  }catch(e){ console.error('loadRooms',e); }
}
function renderRoomEntry(id){
  const make = (container) => {
    const d = document.createElement('div');
    d.className='room';
    d.textContent = '# '+id;
    // Prevent double-calls: mark when touch handled
    d.dataset.touchHandled = '0';

    // click (mouse / non-touch)
    d.addEventListener('click', (ev)=>{
      // ignore click if touchend just handled it (some browsers emit both)
      if(d.dataset.touchHandled === '1') { d.dataset.touchHandled='0'; return; }
      joinRoom(id);
    });

    // explicit touchend handler to ensure tap inside drawer joins immediately
    d.addEventListener('touchend', (ev)=>{
      // stop propagation so global touchend/drag don't interfere
      ev.stopPropagation();
      ev.preventDefault();
      d.dataset.touchHandled = '1';
      setTimeout(()=> d.dataset.touchHandled = '0', 400);
      joinRoom(id);
    }, {passive:false});

    container.appendChild(d);
  };
  make(roomList); make(roomListSidebar); make(roomListMobile);
}

/* Create / join */
createRoomBtn.onclick = async ()=>{
  const r = prompt('Huoneen nimi'); if(!r) return;
  const p = prompt('Salasana (valinnainen)');
  const ref = doc(db,'rooms',r); const snap = await getDoc(ref);
  if(!snap.exists()) await setDoc(ref,{password:p||'',created:serverTimestamp()});
  joinRoom(r);
};

/* joinRoom: if mobile drawer open -> smoothly close then enter room; otherwise enter immediately */
async function joinRoom(r){
  const ref = doc(db,'rooms',r);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert("Huonetta ei l√∂ydy");
  const pass = prompt('Salasana');
  if(pass !== snap.data().password) return alert('V√§√§r√§ salasana');

  nick = nickInput.value || ('Anon'+Math.floor(Math.random()*1000));
  nickColor = nickColorInput.value;
  localStorage.setItem('nick',nick); localStorage.setItem('nickColor',nickColor);

  const durationMs = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--drawer-duration')) || 200;
  const drawerOpen = mobileDrawer.classList.contains('show');

  if(isMobile && drawerOpen){
    // Close drawer smoothly first, then enter room when animation done
    mobileDrawer.classList.remove('show');
    mobileOverlay.classList.remove('show');
    setTimeout(()=> { mobileOverlay.style.display='none'; mobileDrawer.style.display='none'; enterRoom(r); updateOpenLobbyBtnVisibility(); }, durationMs + 20);
  } else {
    enterRoom(r);
  }
}

/* actually subscribe/show room */
async function enterRoom(r){
  showMain();
  room = r; roomName.textContent = '# '+r; chat.innerHTML = '';

  if(messagesUnsub) messagesUnsub();
  if(typingUnsub) typingUnsub();

  const msgsQuery = query(collection(db,'rooms',room,'messages'), orderBy('time'));
  messagesUnsub = onSnapshot(msgsQuery, snap => {
    chat.innerHTML='';
    snap.forEach(d => {
      const m = d.data(); const t = m.time?.toMillis?.()||0;
      if(t>lastMessageTime && document.hidden && m.name!==nick && "Notification" in window && Notification.permission==="granted"){
        new Notification('# '+room,{body:`${m.name}: ${m.text}`});
      }
      lastMessageTime = Math.max(lastMessageTime,t);
      const el = document.createElement('div'); el.className='message';
      el.innerHTML = `<div class="avatar" style="background:${m.color}">${m.name?.[0]||'?'}</div>
        <div class="msg">
          ${m.reply?`<div class="reply-preview"><b>${escapeHtml(m.reply.name)}</b>: ${escapeHtml(m.reply.text)}</div>`:''}
          <b style="color:${m.color}">${escapeHtml(m.name)}</b>
          <span class="time">${t?new Date(t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):''}</span>
          <div>${escapeHtml(m.text)}</div>
          <div class="reply-btn" data-name="${escapeAttr(m.name)}" data-text="${escapeAttr(m.text)}">reply</div>
        </div>`;
      chat.appendChild(el);
    });
    scrollChatToBottom();
  });

  typingUnsub = onSnapshot(collection(db,'rooms',room,'typing'), snap => {
    const now = Date.now(); const users=[];
    snap.forEach(d=>{ const t = d.data().t?.toMillis?.() ?? d.data().t; if(d.id!==nick && t && now-t<2000) users.push(d.id); });
    typingIndicator.textContent = users.length ? users.join(', ') + ' kirjoittaa...' : '';
  });
}

/* typing / send / reply */
msg.addEventListener('input', ()=>{
  if(!room||!nick) return;
  if(msg.value.trim()===''){ deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{}); return; }
  setDoc(doc(db,'rooms',room,'typing',nick),{t:serverTimestamp()});
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=> { deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{}); },1500);
});
msg.addEventListener('blur', ()=> { if(room&&nick) deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{}); });

chat.addEventListener('click', (e)=>{
  const b = e.target.closest('.reply-btn'); if(!b) return;
  replyTo = {name:b.dataset.name, text:b.dataset.text};
  replyBox.style.display='block';
  replyBox.innerHTML = `Vastataan <b>${escapeHtml(replyTo.name)}</b> <button id="cancelReply">x</button>`;
  document.getElementById('cancelReply').onclick = ()=>{ replyTo=null; replyBox.style.display='none'; };
});
msg.addEventListener('keydown', async e=>{
  if(e.key!=='Enter') return;
  const text = msg.value.trim(); msg.value=''; if(!text) return;
  if(!room){ alert('Et ole huoneessa'); return; }
  deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{});
  if(text==='/clear'){ const msgs = await getDocs(collection(db,'rooms',room,'messages')); for(const d of msgs.docs) await deleteDoc(d.ref).catch(()=>{}); return; }
  if(text==='/delete'){ if(!confirm('Poistetaanko koko huone?')) return; const msgs = await getDocs(collection(db,'rooms',room,'messages')); for(const d of msgs.docs) await deleteDoc(d.ref).catch(()=>{}); await deleteDoc(doc(db,'rooms',room)).catch(()=>{}); location.reload(); return; }
  await addDoc(collection(db,'rooms',room,'messages'),{name:nick,text,reply:replyTo,color:nickColorInput.value,time:serverTimestamp()});
  replyTo=null; replyBox.style.display='none';
});

/* emoji */
const emojiList = ["üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÇ","ü§£","üôÇ","üôÉ","üòâ","üòä","üòá","üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòú","ü§™","üòù","ü§ó","ü§≠","ü§´","ü§î","ü§®","üòê","üòë","üò∂","üôÑ","üòè","üò£","üò•","üòÆ","üòØ","üò≤","üò™","üò´","ü•±","üò¥","üòå","üò§","üò†","üò°","ü§¨","üò¢","üò≠","ü•∫","üò≥","üò±","üò®","üò∞","üòì","üëç","üëé","üëå","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëã","üëè","üôå","üôè","‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","üíî","üíï","üíû","üíì","üíó","üíñ","üî•","üíØ","‚ú®","‚≠ê","üåü","‚ö°","üéâ","üéä","üéà","üé∂","üéµ","üòé","ü§ì","üßê","üëÄ","üß†","ü§°","üëª","üëΩ","ü§ñ","üíÄ","üí©","ü´∂"];
emojiList.forEach(e=>{ const d=document.createElement('div'); d.textContent=e; d.onclick=()=>{ msg.value+=e; emojiPicker.style.display='none'; msg.focus(); }; emojiPicker.appendChild(d); });
document.getElementById('emojiBtn').onclick = ()=> emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';

/* back */
back.onclick = ()=> { if(messagesUnsub) messagesUnsub(); if(typingUnsub) typingUnsub(); showHome(); room=''; chat.innerHTML=''; };

/* lobby size (kept) */
const LOBBY_SIZES = [{name:'small',width:'120px'},{name:'normal',width:'260px'},{name:'large',width:'360px'}];
let lobbySizeIndex = parseInt(localStorage.getItem('lobbySizeIndex')||'1',10);
function applyLobbySize(){ const s=LOBBY_SIZES[lobbySizeIndex]; document.documentElement.style.setProperty('--lobby-width', s.width); if(!isMobile){ lobby.classList.remove('collapsed'); chatSidebar.classList.remove('collapsed'); } else { lobby.classList.toggle('collapsed', s.name==='small'); chatSidebar.classList.toggle('collapsed', s.name==='small'); } }
applyLobbySize();
lobbySizeBtn.onclick = ()=> { lobbySizeIndex=(lobbySizeIndex+1)%LOBBY_SIZES.length; applyLobbySize(); localStorage.setItem('lobbySizeIndex',lobbySizeIndex); };

/* Mobile drawer open/close & open-button visibility */
function openMobileDrawer(){ mobileOverlay.classList.add('show'); mobileDrawer.classList.add('show'); mobileOverlay.style.display='block'; mobileDrawer.style.display='block'; mobileOverlay.setAttribute('aria-hidden','false'); mobileDrawer.setAttribute('aria-hidden','false'); updateOpenLobbyBtnVisibility(); }
function closeMobileDrawer(){ mobileDrawer.classList.remove('show'); mobileOverlay.classList.remove('show'); const durationMs = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--drawer-duration'))||200; setTimeout(()=>{ if(!mobileDrawer.classList.contains('show')){ mobileOverlay.style.display='none'; mobileDrawer.style.display='none'; mobileOverlay.setAttribute('aria-hidden','true'); mobileDrawer.setAttribute('aria-hidden','true'); updateOpenLobbyBtnVisibility(); } }, durationMs+20); }
openLobbyBtn.addEventListener('click', openMobileDrawer);
mobileOverlay.addEventListener('click', closeMobileDrawer);
closeDrawer.addEventListener('click', closeMobileDrawer);

function updateOpenLobbyBtnVisibility(){ const drawerOpen = mobileDrawer.classList.contains('show') || mobileOverlay.classList.contains('show'); if(!isMobile){ openLobbyBtn.style.display='none'; return; } const isHomeVisible = home.style.display !== 'none'; openLobbyBtn.style.display = (isHomeVisible && !drawerOpen) ? 'block' : 'none'; }
const origShowHome = showHome; showHome = ()=>{ origShowHome(); updateOpenLobbyBtnVisibility(); }; const origShowMain = showMain; showMain = ()=>{ origShowMain(); updateOpenLobbyBtnVisibility(); }; const origShowLogin = showLogin; showLogin = ()=>{ origShowLogin(); updateOpenLobbyBtnVisibility(); };

/* Drag/touch behavior: improved so taps inside drawer (on .room) don't start drag */
let dragging=false, startX=0, lastX=0, lastT=0, vx=0, drawerWidth=0;
const EDGE_ZONE = 36, SHORT_THRESHOLD=30, VELOCITY_THRESHOLD=0.35;

/* beginDrag moved to start only after move threshold ‚Äî but we also allow immediate drag when starting at edge and moving */
function preparePotentialDrag(x){ startX = x; lastX = x; lastT = performance.now(); drawerWidth = mobileDrawer.getBoundingClientRect().width || (window.innerWidth * 0.8); dragging = false; vx = 0; mobileDrawer.style.transition = 'none'; mobileOverlay.style.transition='none'; if(!mobileOverlay.classList.contains('show')) mobileOverlay.style.display='block'; if(!mobileDrawer.classList.contains('show')) mobileDrawer.style.display='block'; }

/* actual move */
function ensureDragging(){
  if(!dragging){
    dragging = true;
    // remove show so inline transform controls position during drag
    mobileDrawer.classList.remove('show');
  }
}
function dragMove(x){
  ensureDragging();
  const dx = x - startX;
  const wasOpen = mobileDrawer.classList.contains('show');
  let translate = wasOpen ? Math.min(0, dx) : Math.max(-drawerWidth, -drawerWidth + dx);
  translate = Math.max(-drawerWidth, Math.min(0, translate));
  mobileDrawer.style.transform = `translateX(${translate}px)`;
  const openness = 1 - (Math.abs(translate)/drawerWidth);
  mobileOverlay.style.background = `rgba(0,0,0,${0.45 * openness})`;
  mobileOverlay.style.display = 'block';
  const now = performance.now(); const dt = now - lastT || 16;
  vx = (x - lastX) / dt; lastX = x; lastT = now;
}
function endDrag(){
  const style = window.getComputedStyle(mobileDrawer);
  let translateX = 0;
  const matrix = style.transform;
  if(matrix && matrix !== 'none'){
    try{ const values = matrix.match(/matrix.*\((.+)\)/)[1].split(', '); translateX = parseFloat(values[4]); }catch(e){ translateX = 0; }
  } else {
    const m = mobileDrawer.style.transform.match(/translateX\((-?\d+(\.\d+)?)px\)/);
    translateX = m ? parseFloat(m[1]) : 0;
  }
  const wasOpen = mobileDrawer.classList.contains('show');
  const openDecision = (Math.abs(vx) > VELOCITY_THRESHOLD) ? (vx > 0) : (wasOpen ? !(Math.abs(translateX) > SHORT_THRESHOLD) : (Math.abs(translateX) < (drawerWidth - SHORT_THRESHOLD)));
  mobileDrawer.style.transition=''; mobileOverlay.style.transition='';
  if(openDecision){ mobileDrawer.style.transform=''; mobileDrawer.classList.add('show'); mobileOverlay.classList.add('show'); updateOpenLobbyBtnVisibility(); }
  else { mobileDrawer.style.transform = `translateX(-${drawerWidth}px)`; mobileDrawer.classList.remove('show'); mobileOverlay.classList.remove('show'); setTimeout(()=>{ if(!mobileDrawer.classList.contains('show')){ mobileOverlay.style.display='none'; mobileDrawer.style.display='none'; updateOpenLobbyBtnVisibility(); } }, 220); }
  dragging=false; vx=0; mobileDrawer.style.willChange='';
}

/* touch handlers: important fix ‚Äî do NOT start potential drag when touchstart target is a .room element (allow tap) */
let touchStartX=0, touchStartY=0, touchPotential=false;
document.addEventListener('touchstart', (e)=>{
  if(!isMobile) return;
  const t = e.touches[0];
  touchStartX = t.clientX; touchStartY = t.clientY;
  const drawerOpen = mobileDrawer.classList.contains('show');
  const target = e.target;
  const tappedRoom = target.closest && target.closest('.room');
  // If drawer open and tap is on a room, we want the tap to register ‚Äî don't prepare drag
  if(drawerOpen && tappedRoom){
    touchPotential = false; return;
  }
  // otherwise prepare for possible drag if starting at edge or drawerOpen
  if(drawerOpen || (home.style.display !== 'none' && touchStartX <= EDGE_ZONE)){
    touchPotential = true;
    preparePotentialDrag(touchStartX);
  } else {
    touchPotential = false;
  }
}, {passive:true});

document.addEventListener('touchmove', (e)=>{
  if(!isMobile || !touchPotential) return;
  const t = e.touches[0];
  const dx = Math.abs(t.clientX - touchStartX);
  const dy = Math.abs(t.clientY - touchStartY);
  // if vertical dominates, cancel potential drag
  if(dy > dx + 8){ if(dragging) endDrag(); touchPotential=false; return; }
  // if we've moved enough horizontally, start dragging
  if(!dragging && Math.abs(t.clientX - touchStartX) > 6) ensureDragging();
  if(dragging) dragMove(t.clientX);
}, {passive:true});

document.addEventListener('touchend', (e)=>{
  if(!isMobile) return;
  if(dragging) endDrag();
  touchPotential=false;
});

/* keyboard handling (visualViewport) */
function onViewportResize(){ const vv = window.visualViewport; let keyboardHeight=0; if(vv){ keyboardHeight = window.innerHeight - vv.height - (vv.offsetTop||0); if(keyboardHeight<0) keyboardHeight=0; } if(keyboardHeight>0){ chat.style.paddingBottom = (keyboardHeight + 84) + 'px'; setTimeout(()=> scrollChatToBottom(false), 60); } else { chat.style.paddingBottom=''; scrollChatToBottom(); } }
document._lastInnerHeight = window.innerHeight;
window.addEventListener('resize', ()=> { document._lastInnerHeight = Math.max(document._lastInnerHeight||0, window.innerHeight); });
if(window.visualViewport) window.visualViewport.addEventListener('resize', onViewportResize); else window.addEventListener('resize', onViewportResize);
msg.addEventListener('focus', ()=> setTimeout(()=>{ onViewportResize(); scrollChatToBottom(false); }, 60));
msg.addEventListener('blur', ()=> setTimeout(()=> onViewportResize(), 60));

/* rooms refresh polling & snapshot */
async function refreshRoomsEvery(interval=30000){ await loadRooms(); setTimeout(()=>refreshRoomsEvery(interval), interval); }
refreshRoomsEvery();
onSnapshot(collection(db,'rooms'), snap => { roomList.innerHTML=''; roomListSidebar.innerHTML=''; roomListMobile.innerHTML=''; snap.forEach(d=>renderRoomEntry(d.id)); });

/* utilities */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;'); }
function scrollChatToBottom(instant=true){ try{ if(instant) chat.scrollTop = chat.scrollHeight; else chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' }); }catch(e){} }

/* ensure drawer closed on load for mobile */
if(isMobile){ mobileOverlay.style.display='none'; mobileDrawer.style.display='none'; mobileDrawer.classList.remove('show'); mobileOverlay.classList.remove('show'); updateOpenLobbyBtnVisibility(); } else { enforceDesktopLobby(); updateOpenLobbyBtnVisibility(); }

/* visibility -> notifications baseline */
document.addEventListener('visibilitychange', ()=> { if(!document.hidden) lastMessageTime = Date.now(); });

</script>
</body>
</html>
