<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}
body{margin:0;height:100vh;font-family:Inter,sans-serif;background:#0b0f14;color:#e6edf3}
#app{width:100%;height:100%;position:relative}

/* LOGIN */
#loginTab{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#0b0f14}
#loginTab input{padding:12px;border-radius:10px;border:none;margin:6px;width:240px;background:#21262d;color:#fff}
#loginTab button{padding:12px 24px;border-radius:10px;border:none;background:#58a6ff;color:#000;font-weight:600;cursor:pointer;margin-top:10px}
#loginTab h2{margin-bottom:20px}

/* HOME */
#home{display:none;height:100%;flex-direction:column;background:#0b0f14}
#homeTop{padding:12px;display:flex;align-items:center;gap:12px}
#nickDisplay{padding:6px 12px;background:#21262d;border-radius:8px}
#nickColor{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer}
#createRoom{padding:10px 20px;border-radius:10px;background:#58a6ff;color:#000;border:none;font-weight:600;cursor:pointer;margin-left:auto}

/* rooms list */
#homeLeft{width:260px;height:calc(100% - 52px);background:#161b22;padding:14px;overflow-y:auto;border-right:1px solid #0d1117;float:left}
.room{padding:10px 12px;border-radius:8px;background:#21262d;margin-bottom:8px;cursor:pointer}
.room:hover{background:#58a6ff;color:#000}

/* MAIN */
#main{display:none;height:100%;flex-direction:column}
#header{height:52px;background:#161b22;display:flex;align-items:center;padding:0 14px;border-bottom:1px solid #0d1117}
#header button{background:none;border:none;color:#fff;font-size:18px;cursor:pointer;margin-right:10px}
#chatWrapper{display:flex;flex:1;overflow:hidden}
#chatSidebar{width:260px;background:#161b22;border-right:1px solid #0d1117}
#chatWrapperMain{flex:1;display:flex;flex-direction:column}
#chat{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}

/* messages */
.message{display:flex;gap:10px}
.avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:#000}
.msg{background:#161b22;padding:10px 14px;border-radius:10px;width:100%;position:relative}
.time{font-size:11px;color:#8b949e;margin-left:6px}
.reply-btn{position:absolute;right:8px;top:8px;font-size:12px;color:#8b949e;cursor:pointer;opacity:0}
.msg:hover .reply-btn{opacity:1}
.reply-preview{background:#0d1117;border-left:3px solid #58a6ff;padding:6px;font-size:12px;margin-bottom:6px}

/* input */
#replyBox{display:none;background:#21262d;padding:8px 14px;font-size:12px;color:#fff}
#replyBox span{color:#58a6ff}
#inputBar{padding:14px;background:#161b22;border-top:1px solid #0d1117;display:flex;gap:8px;position:relative;align-items:center}
#msg{flex:1;padding:12px;border-radius:8px;border:none;background:#0d1117;color:#fff}
#emojiPicker{display:none;flex-wrap:wrap;gap:4px;padding:6px;background:#21262d;border-radius:8px;position:absolute;bottom:60px;left:14px;max-width:320px;max-height:200px;overflow-y:auto}
#emojiPicker div{cursor:pointer;font-size:18px}
#emojiBtn{border:none;background:#161b22;color:#fff;font-size:18px;cursor:pointer}
#typingIndicator{font-size:12px;color:#8b949e;margin-left:16px}
</style>
</head>
<body>
<div id="app">

<!-- LOGIN TAB -->
<div id="loginTab">
  <h2>Login / Register</h2>
  <input id="loginNick" placeholder="Username">
  <input id="loginPassword" type="password" placeholder="Password">
  <input type="color" id="loginColor" value="#58a6ff">
  <button id="loginBtn">Login / Register</button>
</div>

<!-- HOME LOBBY -->
<div id="home">
  <div id="homeTop">
    <div id="nickDisplay"></div>
    <input type="color" id="nickColorDisplay">
    <button id="createRoom" disabled>Create / Join Room</button>
  </div>
  <div id="homeLeft">
    <h2>Rooms</h2>
    <div id="roomList"></div>
  </div>
</div>

<!-- CHAT MAIN -->
<div id="main">
  <div id="header">
    <button id="back">‚Üê</button>
    <span id="roomName"></span>
  </div>
  <div id="chatWrapper">
    <div id="chatSidebar"></div>
    <div id="chatWrapperMain">
      <div id="chat"></div>
      <div id="typingIndicator"></div>
    </div>
  </div>
  <div id="replyBox"></div>
  <div id="inputBar">
    <button id="emojiBtn">üòä</button>
    <input id="msg" placeholder="Message... (/clear /delete)">
    <div id="emojiPicker"></div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({ apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc", projectId:"chat-fc8ef" });
const db = getFirestore(app);

/* DOM */
const loginTab=document.getElementById("loginTab");
const loginNick=document.getElementById("loginNick");
const loginPassword=document.getElementById("loginPassword");
const loginColor=document.getElementById("loginColor");
const loginBtn=document.getElementById("loginBtn");

const home=document.getElementById("home");
const nickDisplay=document.getElementById("nickDisplay");
const nickColorDisplay=document.getElementById("nickColorDisplay");
const createRoomBtn=document.getElementById("createRoom");
const roomList=document.getElementById("roomList");

const main=document.getElementById("main");
const roomName=document.getElementById("roomName");
const chat=document.getElementById("chat");
const msg=document.getElementById("msg");
const emojiPicker=document.getElementById("emojiPicker");
const emojiBtn=document.getElementById("emojiBtn");
const typingIndicator=document.getElementById("typingIndicator");
const replyBox=document.getElementById("replyBox");

let room="", nick="", nickColor="#58a6ff", replyTo=null;
let lastMessageTime=0, typingTimeout=null;

/* notifications */
if(Notification.permission!=="granted"){ Notification.requestPermission(); }

/* local users */
function getUsers(){ return JSON.parse(localStorage.getItem("users")||"{}"); }
function saveUsers(u){ localStorage.setItem("users",JSON.stringify(u)); }

/* LOGIN / REGISTER */
loginBtn.onclick=()=>{
  const name = loginNick.value.trim();
  const pass = loginPassword.value;
  const color = loginColor.value;
  if(!name || !pass){ alert("Username and password required"); return; }
  const users = getUsers();
  if(users[name]){
    if(users[name].password !== pass){ alert("Wrong password"); return; }
    nickColor = users[name].color;
  } else {
    users[name] = { password: pass, color };
    saveUsers(users);
    nickColor = color;
  }
  nick = name;
  localStorage.setItem("nick", nick);
  localStorage.setItem("nickColor", nickColor);

  /* switch to home lobby */
  loginTab.style.display="none";
  home.style.display="flex";
  nickDisplay.textContent = nick;
  nickColorDisplay.value = nickColor;
  createRoomBtn.disabled=false;
  nickColorDisplay.oninput = ()=>{ nickColor = nickColorDisplay.value; localStorage.setItem("nickColor",nickColor); };
  loadRooms();
};

/* rooms */
async function loadRooms(){
  roomList.innerHTML="";
  const s=await getDocs(collection(db,"rooms"));
  s.forEach(r=>{
    const d=document.createElement("div");
    d.className="room";
    d.textContent="# "+r.id;
    d.onclick=()=>joinRoom(r.id);
    roomList.appendChild(d);
  });
}

/* create/join */
createRoomBtn.onclick=async()=>{
  const r=prompt("Room name"); if(!r) return;
  const p=prompt("Password (optional)");
  const ref=doc(db,"rooms",r);
  if(!(await getDoc(ref)).exists()) await setDoc(ref,{password:p||"",created:serverTimestamp()});
  joinRoom(r);
};

/* join room */
async function joinRoom(r){
  const ref=doc(db,"rooms",r);
  const snap=await getDoc(ref);
  if(!snap.exists()){ alert("Room doesn't exist"); return; }
  const pass=prompt("Password");
  if(pass!==snap.data().password){ alert("Wrong password"); return; }

  home.style.display="none"; main.style.display="flex"; room=r;
  roomName.textContent="# "+r;

  const presenceRef = doc(db,"rooms",room,"users",nick);
  if((await getDoc(presenceRef)).exists()){ alert("User already in room"); return; }
  await setDoc(presenceRef,{t:serverTimestamp()});
  window.addEventListener("beforeunload",()=>{ deleteDoc(doc(db,"rooms",room,"users",nick)); });

  /* messages */
  onSnapshot(query(collection(db,"rooms",room,"messages"),orderBy("time")),snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const t=m.time?.toMillis()||0;
      if(t>lastMessageTime && document.hidden && m.name!==nick){ new Notification("New message."); }
      lastMessageTime=Math.max(lastMessageTime,t);
      const el=document.createElement("div");
      el.className="message";
      el.innerHTML=`
        <div class="avatar" style="background:${m.color}">${m.name[0]}</div>
        <div class="msg">
          ${m.reply?`<div class="reply-preview"><b>${m.reply.name}</b>: ${m.reply.text}</div>`:""}
          <b style="color:${m.color}">${m.name}</b>
          <span class="time">${t?new Date(t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):""}</span>
          <div>${m.text}</div>
          <div class="reply-btn" data-name="${m.name}" data-text="${m.text}">reply</div>
        </div>`;
      chat.appendChild(el);
    });
    chat.scrollTop=chat.scrollHeight;
  });

  /* typing */
  onSnapshot(collection(db,"rooms",room,"typing"),snap=>{
    const now = Date.now();
    const users=[];
    snap.forEach(d=>{
      if(d.id===nick) return;
      if(d.data().t && now-d.data().t<2000) users.push(d.id);
    });
    typingIndicator.textContent = users.length ? users.join(", ")+" typing..." : "";
  });
}

/* typing write */
msg.addEventListener("input",()=>{
  if(!room||!nick) return;
  if(msg.value.trim()===""){ deleteDoc(doc(db,"rooms",room,"typing",nick)); return; }
  setDoc(doc(db,"rooms",room,"typing",nick),{t:Date.now()});
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{ deleteDoc(doc(db,"rooms",room,"typing",nick)); },2000);
});
msg.addEventListener("blur",()=>{ if(room&&nick) deleteDoc(doc(db,"rooms",room,"typing",nick)); });

/* reply */
chat.onclick=e=>{
  const b=e.target.closest(".reply-btn");
  if(!b) return;
  replyTo={name:b.dataset.name,text:b.dataset.text};
  replyBox.style.display="block";
  replyBox.innerHTML=`Replying to <span>${replyTo.name}</span>
    <button onclick="cancelReply()">x</button>`;
};
window.cancelReply=()=>{ replyTo=null; replyBox.style.display="none"; };

/* send messages */
msg.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;
  const text=msg.value.trim(); msg.value="";
  deleteDoc(doc(db,"rooms",room,"typing",nick));
  if(!text) return;
  if(text==="/clear"){
    const msgs=await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref);
    return;
  }
  if(text==="/delete"){
    if(!confirm("Delete entire room?")) return;
    const msgs=await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref);
    await deleteDoc(doc(db,"rooms",room));
    location.reload(); return;
  }
  await addDoc(collection(db,"rooms",room,"messages"),{ name:nick,text,reply:replyTo,color:nickColor,time:serverTimestamp() });
  replyTo=null; replyBox.style.display="none";
});

/* emojis */
[
"üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÇ","ü§£","üôÇ","üôÉ","üòâ","üòä","üòá",
"üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòú","ü§™","üòù",
"ü§ó","ü§≠","ü§´","ü§î","ü§®","üòê","üòë","üò∂","üôÑ","üòè",
"üò£","üò•","üòÆ","üòØ","üò≤","üò™","üò´","ü•±","üò¥","üòå",
"üò§","üò†","üò°","ü§¨","üò¢","üò≠","ü•∫","üò≥","üò±","üò®","üò∞","üòì",
"üëç","üëé","üëå","ü§å","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëã","üëè","üôå","üôè",
"‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","üíî","üíï","üíû","üíì","üíó","üíñ",
"üî•","üíØ","‚ú®","‚≠ê","üåü","‚ö°","üéâ","üéä","üéà","üé∂","üéµ",
"üòé","ü§ì","üßê","üëÄ","üß†","ü§°","üëª","üëΩ","ü§ñ","üíÄ","üí©","ü´∂"
].forEach(e=>{
  const d=document.createElement("div");
  d.textContent=e;
  d.onclick=()=>msg.value+=e;
  emojiPicker.appendChild(d);
});
emojiBtn.onclick=()=>emojiPicker.style.display=emojiPicker.style.display==="flex"?"none":"flex";
msg.onfocus=()=>emojiPicker.style.display="none";

document.getElementById("back").onclick=()=>{ location.reload(); };

</script>
</body>
</html>
