<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MiniChat ‚Äî Mobile-friendly</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14;
    --panel:#161b22;
    --muted:#8b949e;
    --accent:#58a6ff;
    --card:#21262d;
    --text:#e6edf3;
    --lobby-width:260px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  #app{width:100%;height:100%;position:relative;overflow:hidden}

/* LOGIN */
  #login{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px;background:var(--bg);z-index:30;padding:20px;}
  #login input{padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text);width:100%;max-width:320px}
  #login button{padding:12px 18px;border:none;border-radius:10px;background:var(--accent);color:#000;font-weight:700;cursor:pointer;max-width:320px;width:100%}
  #login .small{background:transparent;border:1px solid #333;padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}

/* APP LAYOUT */
  #home,#main{position:absolute;inset:0;display:none}
  #home{display:flex;flex-direction:row}
  #logoutBtn{position:absolute;top:12px;right:12px;padding:8px 12px;background:#f85149;color:#fff;border:none;border-radius:10px;cursor:pointer;z-index:25;font-weight:700}

/* Lobby (left) */
  #homeLeft{width:var(--lobby-width);min-width:120px;background:var(--panel);padding:12px;border-right:1px solid #0d1117;height:100%;overflow:auto;transition:width 200ms ease,transform 220ms cubic-bezier(.2,.9,.3,1);position:relative;}
  #homeLeft.collapsed{width:40px;padding:8px}
  #lobbyHeader{display:flex;align-items:center;gap:8px;margin-bottom:10px}
  #lobbyTitle{flex:1;font-weight:700}
  .room{padding:10px 12px;border-radius:10px;background:var(--card);margin-bottom:8px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .room:hover{background:var(--accent);color:#000}

/* lobby controls */
  #lobbyControls{display:flex;gap:6px;align-items:center;margin-bottom:8px}
  .iconbtn{background:transparent;border:0;color:var(--text);padding:6px;border-radius:8px;cursor:pointer}
  .iconbtn:active{transform:scale(0.98)}
  #lobbySizeBtn{font-weight:700;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03)}

/* center */
  #homeCenter{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;padding:18px}
  #nickRow{display:flex;gap:12px;width:100%;max-width:420px;align-items:center;margin-bottom:20px}
  #nick{flex:1;padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text)}
  #nickColorWrapper{width:42px;height:42px;position:relative}
  #nickColorCircle{width:100%;height:100%;border-radius:50%;border:2px solid #fff;cursor:pointer}
  #createRoom{padding:14px 28px;border-radius:12px;background:var(--accent);color:#000;border:none;font-weight:700;cursor:pointer}

/* MAIN chat */
  #main{display:flex;flex-direction:column}
  #header{height:56px;background:var(--panel);display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #0d1117}
  #header .left{display:flex;align-items:center;gap:8px}
  #roomName{font-weight:700}
  #chatWrapper{display:flex;flex:1;overflow:hidden;min-height:0}
  #chatSidebar{width:var(--lobby-width);background:var(--panel);border-right:1px solid #0d1117;padding:8px;overflow:auto;transition:width 200ms ease;box-sizing:border-box;}
  #chatSidebar.collapsed{width:40px;padding:6px}
  #chatWrapperMain{flex:1;display:flex;flex-direction:column;min-height:0}
  #chat{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,transparent, rgba(255,255,255,0.01));transition:padding-bottom 160ms ease}
  .message{display:flex;gap:10px;align-items:flex-start}
  .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#000}
  .msg{background:var(--panel);padding:10px 14px;border-radius:12px;position:relative;max-width:90%}
  .time{font-size:11px;color:var(--muted);margin-left:6px}
  .reply-btn{position:absolute;right:8px;top:8px;font-size:12px;color:var(--muted);cursor:pointer;opacity:0}
  .msg:hover .reply-btn{opacity:1}
  .reply-preview{background:rgba(255,255,255,0.02);border-left:3px solid var(--accent);padding:6px;font-size:13px;margin-bottom:8px;border-radius:6px}

/* input area */
  #replyBox{display:none;background:var(--card);padding:8px 14px;font-size:13px;color:var(--text)}
  #inputBar{padding:12px;background:var(--panel);border-top:1px solid #0d1117;display:flex;gap:8px;align-items:center}
  #msg{flex:1;padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text)}
  #emojiPicker{display:none;flex-wrap:wrap;gap:6px;padding:8px;background:var(--card);border-radius:8px;position:absolute;bottom:72px;left:12px;max-width:320px;max-height:200px;overflow:auto}
  #emojiPicker div{cursor:pointer;font-size:18px}
  #emojiBtn{border:none;background:transparent;color:var(--text);font-size:20px;cursor:pointer}

/* mobile specifics */
  .mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:40;display:none;transition:background 220ms ease}
  .mobile-overlay.show{display:block;background:rgba(0,0,0,0.45)}
  .mobile-lobby-drawer{position:fixed;left:0;top:0;height:100%;width:80%;max-width:340px;background:var(--panel);z-index:50;padding:12px;transform:translateX(-110%);transition:transform 220ms cubic-bezier(.2,.9,.3,1),opacity 200ms ease;opacity:0;will-change:transform}
  .mobile-lobby-drawer.show{transform:translateX(0);opacity:1}
  #openLobbyBtn{position:fixed;left:12px;bottom:12px;background:var(--accent);border:none;padding:12px;border-radius:999px;z-index:60;font-weight:800;color:#000;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.5)}

/* collapsed small labels */
  .collapsed .label-text{display:none}
  .collapsed .room{padding:8px;border-radius:8px;text-align:center}

/* responsive */
  @media (max-width:900px){:root{--lobby-width:220px}}
  @media (max-width:768px){
    #home{flex-direction:column}
    #homeLeft{display:none} /* desktop lobby hidden on mobile (we use drawer) */
    #chatSidebar{display:none}
    #header{padding:10px}
    #nickRow{max-width:100%}
  }

  .fade{transition:opacity 180ms ease,transform 180ms ease}
  button, .iconbtn{outline: none}
</style>
</head>
<body>
<div id="app">

  <!-- LOGIN -->
  <div id="login" aria-hidden="false">
    <input id="loginUser" placeholder="K√§ytt√§j√§nimi" autocomplete="username">
    <input id="loginPass" type="password" placeholder="Salasana" autocomplete="current-password">
    <button id="loginBtn">Kirjaudu / Rekister√∂idy</button>
    <button id="demoBtn" class="small">Continue as Guest</button>
  </div>

  <!-- HOME -->
  <div id="home">
    <button id="logoutBtn" title="Logout">Logout</button>

    <!-- Desktop lobby (keeps desktop visible) -->
    <aside id="homeLeft" aria-label="Lobby">
      <div id="lobbyHeader">
        <div id="lobbyTitle">Huoneet</div>
        <div id="lobbyControls">
          <button id="lobbyToggle" class="iconbtn" title="Collapse/Expand lobby">‚óÄ</button>
          <button id="lobbySizeBtn" class="iconbtn" title="Change lobby size">A</button>
        </div>
      </div>
      <div id="roomList"></div>
    </aside>

    <!-- Center -->
    <main id="homeCenter">
      <div id="nickRow">
        <input id="nick" placeholder="Nimimerkki (tallennetaan)">
        <div id="nickColorWrapper">
          <div id="nickColorCircle" title="V√§ri"></div>
          <input type="color" id="nickColor" value="#58a6ff" style="position:absolute;opacity:0;left:0;top:0;width:100%;height:100%;">
        </div>
      </div>
      <button id="createRoom">Luo / Liity huoneeseen</button>
      <div style="margin-top:16px;color:var(--muted);font-size:13px;text-align:center;max-width:420px">
        Pyyhk√§ise reunasta avataksesi huonevalikon mobiilissa.
      </div>
    </main>
  </div>

  <!-- MAIN CHAT -->
  <div id="main" aria-hidden="true">
    <div id="header">
      <div class="left">
        <button id="back" class="iconbtn" title="Back">‚Üê</button>
        <div id="roomName">#room</div>
      </div>
      <div style="flex:1"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="typingIndicator" style="color:var(--muted);font-size:13px"></div>
      </div>
    </div>

    <div id="chatWrapper">
      <aside id="chatSidebar" aria-label="Chat sidebar">
        <div id="chatRoomsHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Huoneet</div>
          <button id="sidebarToggle" class="iconbtn" title="Collapse">‚óÄ</button>
        </div>
        <div id="roomListSidebar"></div>
      </aside>

      <div id="chatWrapperMain">
        <div id="chat"></div>
        <div id="replyBox"></div>
        <div id="inputBar">
          <button id="emojiBtn">üòä</button>
          <input id="msg" placeholder="Viesti... (/clear /delete)" autocomplete="off">
          <div id="emojiPicker"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile overlay and drawer -->
  <div id="mobileOverlay" class="mobile-overlay" aria-hidden="true"></div>
  <div id="mobileDrawer" class="mobile-lobby-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">Huoneet</div>
      <button id="closeDrawer" class="iconbtn">‚úï</button>
    </div>
    <div id="roomListMobile"></div>
  </div>

  <!-- Blue three-line button (mobile) -->
  <button id="openLobbyBtn" title="Avaa lobby">‚ò∞</button>

</div>

<script type="module">
/* ===================
   App logic (single module)
   - Drag feedback both directions for mobile drawer
   - VisualViewport-based keyboard handling: keep chat visible above keyboard
   - Desktop lobby enforced visible (unchanged behavior)
   =================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase init */
const firebaseConfig = {
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM refs */
const login = document.getElementById('login');
const home = document.getElementById('home');
const main = document.getElementById('main');
const loginBtn = document.getElementById('loginBtn');
const demoBtn = document.getElementById('demoBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const logoutBtn = document.getElementById('logoutBtn');

const roomList = document.getElementById('roomList');
const roomListSidebar = document.getElementById('roomListSidebar');
const roomListMobile = document.getElementById('roomListMobile');

const createRoomBtn = document.getElementById('createRoom');
const nickInput = document.getElementById('nick');
const nickColorInput = document.getElementById('nickColor');
const nickColorCircle = document.getElementById('nickColorCircle');

const lobby = document.getElementById('homeLeft');
const lobbyToggle = document.getElementById('lobbyToggle');
const lobbySizeBtn = document.getElementById('lobbySizeBtn');

const chatSidebar = document.getElementById('chatSidebar');
const sidebarToggle = document.getElementById('sidebarToggle');

const openLobbyBtn = document.getElementById('openLobbyBtn');
const mobileOverlay = document.getElementById('mobileOverlay');
const mobileDrawer = document.getElementById('mobileDrawer');
const closeDrawer = document.getElementById('closeDrawer');

const chat = document.getElementById('chat');
const chatWrapperMain = document.getElementById('chatWrapperMain');
const msg = document.getElementById('msg');
const replyBox = document.getElementById('replyBox');
const roomName = document.getElementById('roomName');
const emojiPicker = document.getElementById('emojiPicker');
const emojiBtn = document.getElementById('emojiBtn');
const typingIndicator = document.getElementById('typingIndicator');
const back = document.getElementById('back');

let users = JSON.parse(localStorage.getItem('users')||'{}');
let nick = '';
let nickColor = localStorage.getItem('nickColor')||'#58a6ff';
let room = '';
let replyTo = null;
let lastMessageTime = 0;
let typingTimeout = null;
let messagesUnsub = null;
let typingUnsub = null;

/* Device detection */
const isTouch = matchMedia('(pointer:coarse)').matches;
const isMobile = /Mobi|Android|iPhone|iPad|Windows Phone/.test(navigator.userAgent) || isTouch;

/* Initial UI */
nickColorInput.value = nickColor;
nickColorCircle.style.background = nickColor;
nickInput.value = localStorage.getItem('nick') || '';

/* Notification permission */
if("Notification" in window && Notification.permission !== 'granted'){
  Notification.requestPermission().catch(()=>{});
}

/* Ensure desktop lobby visible and cannot be collapsed:
   If not mobile, force visible and hide collapse controls. */
function enforceDesktopLobby(){
  if(!isMobile){
    lobby.style.display = 'block';
    chatSidebar.style.display = 'block';
    // hide collapse buttons on desktop
    if(lobbyToggle) lobbyToggle.style.display = 'none';
    if(sidebarToggle) sidebarToggle.style.display = 'none';
  } else {
    lobby.style.display = 'none';
    chatSidebar.style.display = 'none';
  }
}
enforceDesktopLobby();

/* Session UI */
function showHome(){
  login.style.display = 'none';
  home.style.display = 'flex';
  main.style.display = 'none';
  updateOpenLobbyBtnVisibility();
}
function showLogin(){
  login.style.display = 'flex';
  home.style.display = 'none';
  main.style.display = 'none';
  localStorage.removeItem('session');
  updateOpenLobbyBtnVisibility();
}
function showMain(){
  login.style.display = 'none';
  home.style.display = 'none';
  main.style.display = 'flex';
  updateOpenLobbyBtnVisibility();
}

/* restore session */
if(localStorage.getItem('session')){
  showHome();
} else {
  showLogin();
}

/* login handlers */
loginBtn.onclick = () => {
  const u = loginUser.value.trim();
  const p = loginPass.value;
  if(!u||!p) return alert('T√§yt√§ molemmat kent√§t');
  if(users[u] && users[u] !== p) return alert('V√§√§r√§ salasana');
  users[u] = p;
  localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('session',u);
  nickInput.value = u;
  localStorage.setItem('nick', u);
  showHome();
};
demoBtn.onclick = () => {
  const guest = 'Guest' + Math.floor(Math.random()*10000);
  localStorage.setItem('session', guest);
  nickInput.value = guest;
  localStorage.setItem('nick', guest);
  showHome();
};
logoutBtn.onclick = ()=> { showLogin(); };

/* nick color UI */
nickColorCircle.addEventListener('click', ()=> nickColorInput.click());
nickColorInput.addEventListener('input', ()=>{
  nickColorCircle.style.background = nickColorInput.value;
  localStorage.setItem('nickColor', nickColorInput.value);
});

/* rooms */
async function loadRooms(){
  roomList.innerHTML = '';
  roomListSidebar.innerHTML = '';
  roomListMobile.innerHTML = '';
  try{
    const s = await getDocs(collection(db,'rooms'));
    s.forEach(r => {
      renderRoomEntry(r.id);
    });
  }catch(e){ console.error('loadRooms error', e); }
}
function renderRoomEntry(id){
  const createEl = (container) => {
    const d = document.createElement('div');
    d.className = 'room';
    d.textContent = '# ' + id;
    d.onclick = ()=> joinRoom(id);
    container.appendChild(d);
  };
  createEl(roomList);
  createEl(roomListSidebar);
  createEl(roomListMobile);
}

/* create/join */
createRoomBtn.onclick = async ()=>{
  const r = prompt('Huoneen nimi'); if(!r) return;
  const p = prompt('Salasana (valinnainen)');
  const ref = doc(db,'rooms',r);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{password:p||'',created:serverTimestamp()});
  }
  joinRoom(r);
};

async function joinRoom(r){
  const ref = doc(db,'rooms',r);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert("Huonetta ei l√∂ydy");
  const pass = prompt('Salasana');
  if(pass !== snap.data().password) return alert('V√§√§r√§ salasana');

  nick = nickInput.value || ('Anon'+Math.floor(Math.random()*1000));
  nickColor = nickColorInput.value;
  localStorage.setItem('nick', nick);
  localStorage.setItem('nickColor', nickColor);

  showMain();
  room = r;
  roomName.textContent = '# ' + r;
  chat.innerHTML = '';

  if(messagesUnsub) messagesUnsub();
  if(typingUnsub) typingUnsub();

  const msgsQuery = query(collection(db,'rooms',room,'messages'), orderBy('time'));
  messagesUnsub = onSnapshot(msgsQuery, snap => {
    chat.innerHTML = '';
    snap.forEach(d => {
      const m = d.data();
      const t = m.time?.toMillis?.() || 0;
      if(t > lastMessageTime && document.hidden && m.name !== nick && "Notification" in window && Notification.permission === "granted"){
        new Notification('# '+room, { body: `${m.name}: ${m.text}` });
      }
      lastMessageTime = Math.max(lastMessageTime, t);

      const el = document.createElement('div');
      el.className = 'message';
      el.innerHTML = `
        <div class="avatar" style="background:${m.color}">${m.name?.[0]||'?'}</div>
        <div class="msg">
          ${m.reply?`<div class="reply-preview"><b>${escapeHtml(m.reply.name)}</b>: ${escapeHtml(m.reply.text)}</div>`:''}
          <b style="color:${m.color}">${escapeHtml(m.name)}</b>
          <span class="time">${t?new Date(t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):''}</span>
          <div>${escapeHtml(m.text)}</div>
          <div class="reply-btn" data-name="${escapeAttr(m.name)}" data-text="${escapeAttr(m.text)}">reply</div>
        </div>
      `;
      chat.appendChild(el);
    });
    scrollChatToBottom();
  });

  typingUnsub = onSnapshot(collection(db,'rooms',room,'typing'), snap => {
    const now = Date.now();
    const users = [];
    snap.forEach(d=>{
      const t = d.data().t?.toMillis?.() ?? d.data().t;
      if(d.id !== nick && t && now - t < 2000) users.push(d.id);
    });
    typingIndicator.textContent = users.length ? users.join(', ') + ' kirjoittaa...' : '';
  });

  // sulje drawer jos auki
  closeMobileDrawer();
}

/* typing */
msg.addEventListener('input', ()=>{
  if(!room || !nick) return;
  if(msg.value.trim()===''){
    deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{});
    return;
  }
  setDoc(doc(db,'rooms',room,'typing',nick),{t:serverTimestamp()});
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=> { deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{}); }, 1500);
});
msg.addEventListener('blur', ()=> { if(room && nick) deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{}); });

/* reply */
chat.addEventListener('click', (e)=>{
  const b = e.target.closest('.reply-btn');
  if(!b) return;
  replyTo = { name: b.dataset.name, text: b.dataset.text };
  replyBox.style.display = 'block';
  replyBox.innerHTML = `Vastataan <b>${escapeHtml(replyTo.name)}</b> <button id="cancelReply" style="margin-left:8px">x</button>`;
  document.getElementById('cancelReply').onclick = cancelReply;
});
function cancelReply(){ replyTo = null; replyBox.style.display = 'none'; }

/* send */
msg.addEventListener('keydown', async (e)=>{
  if(e.key !== 'Enter') return;
  const text = msg.value.trim(); msg.value = ''; if(!text) return;
  if(!room){ alert('Et ole huoneessa'); return; }
  deleteDoc(doc(db,'rooms',room,'typing',nick)).catch(()=>{});

  if(text === '/clear'){
    const msgs = await getDocs(collection(db,'rooms',room,'messages'));
    for(const d of msgs.docs) await deleteDoc(d.ref).catch(()=>{});
    return;
  }
  if(text === '/delete'){
    if(!confirm('Poistetaanko koko huone?')) return;
    const msgs = await getDocs(collection(db,'rooms',room,'messages'));
    for(const d of msgs.docs) await deleteDoc(d.ref).catch(()=>{});
    await deleteDoc(doc(db,'rooms',room)).catch(()=>{});
    location.reload();
    return;
  }

  await addDoc(collection(db,'rooms',room,'messages'), {
    name: nick, text, reply: replyTo, color: nickColorInput.value, time: serverTimestamp()
  }).catch(console.error);
  replyTo = null; replyBox.style.display = 'none';
});

/* emojis */
const emojiList = [
"üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÇ","ü§£","üôÇ","üôÉ","üòâ","üòä","üòá",
"üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòú","ü§™","üòù",
"ü§ó","ü§≠","ü§´","ü§î","ü§®","üòê","üòë","üò∂","üôÑ","üòè",
"üò£","üò•","üòÆ","üòØ","üò≤","üò™","üò´","ü•±","üò¥","üòå",
"üò§","üò†","üò°","ü§¨","üò¢","üò≠","ü•∫","üò≥","üò±","üò®","üò∞","üòì",
"üëç","üëé","üëå","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëã","üëè","üôå","üôè",
"‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","üíî","üíï","üíû","üíì","üíó","üíñ",
"üî•","üíØ","‚ú®","‚≠ê","üåü","‚ö°","üéâ","üéä","üéà","üé∂","üéµ",
"üòé","ü§ì","üßê","üëÄ","üß†","ü§°","üëª","üëΩ","ü§ñ","üíÄ","üí©","ü´∂"
];
emojiList.forEach(e=>{
  const d = document.createElement('div'); d.textContent = e;
  d.onclick = ()=> { msg.value += e; emojiPicker.style.display = 'none'; msg.focus(); };
  emojiPicker.appendChild(d);
});
emojiBtn.onclick = ()=> emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';

/* back */
back.onclick = ()=> {
  if(messagesUnsub) messagesUnsub();
  if(typingUnsub) typingUnsub();
  showHome();
  room = '';
  chat.innerHTML = '';
};

/* lobby size (feature kept) */
const LOBBY_SIZES = [
  {name:'small', width:'120px'},
  {name:'normal', width:'260px'},
  {name:'large', width:'360px'}
];
let lobbySizeIndex = parseInt(localStorage.getItem('lobbySizeIndex')||'1',10);
applyLobbySize();

lobbySizeBtn.addEventListener('click', ()=> {
  lobbySizeIndex = (lobbySizeIndex + 1) % LOBBY_SIZES.length;
  applyLobbySize();
  localStorage.setItem('lobbySizeIndex', lobbySizeIndex);
});
function applyLobbySize(){
  const s = LOBBY_SIZES[lobbySizeIndex];
  document.documentElement.style.setProperty('--lobby-width', s.width);
  lobbySizeBtn.textContent = s.name[0].toUpperCase();
  if(isMobile) {
    const collapse = (s.name === 'small');
    lobby.classList.toggle('collapsed', collapse);
    chatSidebar.classList.toggle('collapsed', collapse);
  } else {
    lobby.classList.remove('collapsed');
    chatSidebar.classList.remove('collapsed');
  }
}

/* Mobile drawer open/close with smooth animation + drag feedback both directions */
openLobbyBtn.addEventListener('click', openMobileDrawer);
mobileOverlay.addEventListener('click', closeMobileDrawer);
closeDrawer.addEventListener('click', closeMobileDrawer);

function openMobileDrawer(){
  mobileOverlay.classList.add('show');
  mobileDrawer.classList.add('show');
  mobileOverlay.style.display = 'block'; mobileDrawer.style.display = 'block';
  mobileOverlay.setAttribute('aria-hidden','false'); mobileDrawer.setAttribute('aria-hidden','false');
  updateOpenLobbyBtnVisibility();
}
function closeMobileDrawer(){
  mobileOverlay.classList.remove('show');
  mobileDrawer.classList.remove('show');
  setTimeout(()=>{ 
    if(!mobileDrawer.classList.contains('show')){
      mobileOverlay.style.display = 'none'; mobileDrawer.style.display = 'none';
      mobileOverlay.setAttribute('aria-hidden','true'); mobileDrawer.setAttribute('aria-hidden','true');
      updateOpenLobbyBtnVisibility();
    }
  }, 260);
}

/* Visibility logic for the blue button */
function updateOpenLobbyBtnVisibility(){
  const drawerOpen = mobileDrawer.classList.contains('show') || mobileOverlay.classList.contains('show');
  if(!isMobile){
    openLobbyBtn.style.display = 'none';
    return;
  }
  const isHomeVisible = home.style.display !== 'none';
  if(isHomeVisible && !drawerOpen){
    openLobbyBtn.style.display = 'block';
  } else {
    openLobbyBtn.style.display = 'none';
  }
}
/* override show* functions to update button visibility */
const origShowHome = showHome;
showHome = function(){ origShowHome(); updateOpenLobbyBtnVisibility(); };
const origShowMain = showMain;
showMain = function(){ origShowMain(); updateOpenLobbyBtnVisibility(); };
const origShowLogin = showLogin;
showLogin = function(){ origShowLogin(); updateOpenLobbyBtnVisibility(); };

/* --- Drag-to-open/close handling --- */
let dragActive = false;
let dragStartX = 0;
let dragInitialTranslate = 0;
let drawerWidth = 0;
const SWIPE_THRESHOLD = 60;
const EDGE_ZONE = 48;

function startDrag(startX, startingOpen){
  dragActive = true;
  dragStartX = startX;
  drawerWidth = mobileDrawer.getBoundingClientRect().width || (window.innerWidth * 0.8);
  dragInitialTranslate = startingOpen ? 0 : -drawerWidth;
  // make visible for dragging
  mobileOverlay.style.display = 'block';
  mobileDrawer.style.display = 'block';
  mobileOverlay.classList.add('show'); // backgrounds handled by CSS
  mobileDrawer.classList.remove('show'); // we'll control transform manually
  mobileDrawer.style.transition = 'none';
  mobileOverlay.style.transition = 'none';
  mobileDrawer.style.willChange = 'transform';
  mobileOverlay.style.background = 'rgba(0,0,0,0)';
}

function onDragMove(currentX){
  if(!dragActive) return;
  const dx = currentX - dragStartX;
  let translate = dragInitialTranslate + dx;
  if(translate > 0) translate = 0;
  if(translate < -drawerWidth) translate = -drawerWidth;
  mobileDrawer.style.transform = `translateX(${translate}px)`;
  const opacityFactor = 1 - (Math.abs(translate) / drawerWidth);
  mobileOverlay.style.background = `rgba(0,0,0,${0.45 * opacityFactor})`;
  mobileOverlay.style.display = 'block';
}

function endDrag(){
  if(!dragActive) return;
  dragActive = false;
  // read current transform
  const style = window.getComputedStyle(mobileDrawer);
  const matrix = style.transform;
  let translateX = 0;
  if(matrix && matrix !== 'none'){
    const values = matrix.match(/matrix.*\((.+)\)/)[1].split(', ');
    translateX = parseFloat(values[4]); // tx
  } else {
    // fallback to inline style
    const m = mobileDrawer.style.transform.match(/translateX\((-?\d+)px\)/);
    translateX = m ? parseFloat(m[1]) : 0;
  }
  // decide open/close threshold
  if(translateX > -drawerWidth / 3){
    // open
    mobileDrawer.style.transition = '';
    mobileOverlay.style.transition = '';
    mobileDrawer.style.transform = '';
    mobileDrawer.classList.add('show');
    mobileOverlay.classList.add('show');
    updateOpenLobbyBtnVisibility();
  } else {
    // close
    mobileDrawer.style.transition = '';
    mobileOverlay.style.transition = '';
    mobileDrawer.classList.remove('show');
    mobileOverlay.classList.remove('show');
    // allow the earlier timeout to hide elements after CSS animation
    setTimeout(()=>{ if(!mobileDrawer.classList.contains('show')){ mobileOverlay.style.display = 'none'; mobileDrawer.style.display = 'none'; updateOpenLobbyBtnVisibility(); } }, 260);
  }
  // cleanup
  mobileDrawer.style.willChange = '';
  mobileOverlay.style.background = '';
}

/* touch handlers (both open and close) */
let touchStartX = 0;
let touchStartY = 0;
let touchHandled = false;

document.addEventListener('touchstart', (e)=>{
  if(!isMobile) return;
  const t = e.touches[0];
  touchStartX = t.clientX;
  touchStartY = t.clientY;
  touchHandled = false;

  const drawerOpen = mobileDrawer.classList.contains('show');
  // start drag if:
  // - drawer is open (allow drag to close) OR
  // - drawer closed and touch starts near left edge AND we're on HOME view
  if(drawerOpen || (home.style.display !== 'none' && touchStartX < EDGE_ZONE)){
    startDrag(touchStartX, drawerOpen);
    touchHandled = true;
  }
});

document.addEventListener('touchmove', (e)=>{
  if(!isMobile || !touchHandled || !dragActive) return;
  const t = e.touches[0];
  const dx = t.clientX - touchStartX;
  // if vertical movement dominates, cancel drag
  if(Math.abs(t.clientY - touchStartY) > Math.abs(dx) + 10) {
    // abort drag gracefully
    endDrag();
    touchHandled = false;
    return;
  }
  onDragMove(t.clientX);
});

document.addEventListener('touchend', (e)=>{
  if(!isMobile || !touchHandled) return;
  endDrag();
  touchHandled = false;
});

/* Rooms refresh polling */
async function refreshRoomsEvery(interval=30000){
  await loadRooms();
  setTimeout(()=>refreshRoomsEvery(interval), interval);
}
refreshRoomsEvery();

/* keep room list updated with onSnapshot */
onSnapshot(collection(db,'rooms'), snap => {
  roomList.innerHTML = ''; roomListSidebar.innerHTML = ''; roomListMobile.innerHTML = '';
  snap.forEach(d => renderRoomEntry(d.id));
});

/* small safety: escape HTML helpers */
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;'); }

/* Helper: scroll chat to bottom */
function scrollChatToBottom(instant = true){
  try{
    if(instant) chat.scrollTop = chat.scrollHeight;
    else chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
  }catch(e){}
}

/* --- VisualViewport / keyboard handling ---
   Keep chat visible above virtual keyboard:
   - listen to visualViewport.resize or window.resize fallback
   - set chat padding-bottom to keyboard height + small offset
   - when input focused, scroll to bottom after small delay
*/
function onViewportResize(){
  // compute keyboard height if visualViewport available
  const vv = window.visualViewport;
  let keyboardHeight = 0;
  if(vv){
    keyboardHeight = window.innerHeight - vv.height - (vv.offsetTop || 0);
    if(keyboardHeight < 0) keyboardHeight = 0;
  } else {
    // fallback: use safe heuristic with window.innerHeight change
    keyboardHeight = Math.max(0, (document._lastInnerHeight || window.innerHeight) - window.innerHeight);
  }

  if(keyboardHeight > 0){
    chat.style.paddingBottom = (keyboardHeight + 80) + 'px'; // 80px to account for input bar + spacing
    // also ensure inputBar is visible by scrolling slightly
    setTimeout(()=> scrollChatToBottom(false), 60);
  } else {
    chat.style.paddingBottom = '';
    scrollChatToBottom();
  }
}

// store initial innerHeight for fallback
document._lastInnerHeight = window.innerHeight;
window.addEventListener('resize', ()=> { document._lastInnerHeight = Math.max(document._lastInnerHeight || 0, window.innerHeight); });

// attach listener
if(window.visualViewport){
  window.visualViewport.addEventListener('resize', onViewportResize);
} else {
  window.addEventListener('resize', onViewportResize);
}

// when message input focused, ensure chat stays above keyboard and scrolls
msg.addEventListener('focus', ()=>{
  setTimeout(()=> {
    onViewportResize();
    scrollChatToBottom(false);
  }, 60);
});
msg.addEventListener('blur', ()=>{
  setTimeout(()=> { onViewportResize(); }, 60);
});

/* initial mobile drawer closed on load */
if(isMobile){
  mobileOverlay.style.display = 'none';
  mobileDrawer.style.display = 'none';
  mobileDrawer.classList.remove('show');
  mobileOverlay.classList.remove('show');
  updateOpenLobbyBtnVisibility();
} else {
  enforceDesktopLobby();
  updateOpenLobbyBtnVisibility();
}

/* Notification helper when hidden */
document.addEventListener('visibilitychange', ()=> {
  if(!document.hidden) lastMessageTime = Date.now();
});

/* small UX: scroll to bottom when new messages arrive (already handled) */

/* End of module */
</script>
</body>
</html>
